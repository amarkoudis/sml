{% extends "layout.html" %}

{% block title %}Edit Event{% endblock %}

{% block sidebar %}
<!-- Sidebar - This will be included in the layout.html file -->
<div class="sidebar">
    <div class="sidebar-header">
        <h5 class="sidebar-title">Event Management</h5>
    </div>
    <div class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Event</div>
            <div class="nav-item" data-section="section-basic-info">
                <i class="fas fa-info-circle"></i>
                <span class="nav-text">Basic Information</span>
            </div>
            <div class="nav-item" data-section="section-date-time">
                <i class="fas fa-clock"></i>
                <span class="nav-text">Date and Time</span>
            </div>
            <div class="nav-item" data-section="section-location">
                <i class="fas fa-map-marker-alt"></i>
                <span class="nav-text">Location</span>
            </div>
            <div class="nav-item" data-section="section-staff">
                <i class="fas fa-users"></i>
                <span class="nav-text">Staff Requirements</span>
            </div>
            <div class="nav-item" data-section="section-shifts">
                <i class="fas fa-calendar-alt"></i>
                <span class="nav-text">Shift Management</span>
            </div>
            <div class="nav-item" data-section="section-financial">
                <i class="fas fa-euro-sign"></i>
                <span class="nav-text">Financial Information</span>
            </div>
            <div class="nav-item" data-section="section-status">
                <i class="fas fa-tasks"></i>
                <span class="nav-text">Event Status</span>
            </div>
            <div class="nav-item" data-section="section-staff-report">
                <i class="fas fa-chart-pie"></i>
                <span class="nav-text">Staff Report</span>
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Actions</div>
            <div class="nav-item" data-action="save-form">
                <i class="fas fa-save"></i>
                <span class="nav-text">Save Event</span>
            </div>
            <div class="nav-item" data-action="cancel-form">
                <i class="fas fa-times-circle"></i>
                <span class="nav-text">Cancel</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Modern layout with sidebar */
    .app-container {
        display: flex;
        min-height: calc(100vh - 60px);
    }
    
    .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 30px;
        background-color: #f5f8fa;
        transition: all 0.3s ease;
    }
    
    .content-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .page-header {
        margin-bottom: 30px;
    }
    
    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #1e293b;
    }
    
    .page-subtitle {
        color: #64748b;
        font-size: 1rem;
    }
    
    /* Modern card styling */
    .modern-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        background-color: #fff;
        overflow: hidden;
        margin-bottom: 24px;
    }
    
    .modern-section-header {
        background-color: #fff;
        border-bottom: 1px solid #e9ecef;
        padding: 16px 24px;
    }
    
    .modern-title {
        color: #1e293b;
        font-weight: 600;
    }
    
    .modern-card .card-body {
        padding: 24px;
    }
    
    /* Form styling */
    .modern-label {
        font-weight: 500;
        color: #334155;
        margin-bottom: 8px;
    }
    
    .modern-input, .modern-select {
        border-radius: 8px;
        padding: 12px 16px;
        border: 1px solid #cbd5e1;
        background-color: #f8fafc;
        transition: all 0.2s;
    }
    
    .modern-input:focus, .modern-select:focus {
        border-color: #4f97fb;
        box-shadow: 0 0 0 3px rgba(79, 151, 251, 0.25);
        background-color: #fff;
    }
    
    .modern-form-group {
        margin-bottom: 20px;
    }
    
    .modern-btn {
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .btn-primary.modern-btn {
        background-color: #4f97fb;
        border-color: #4f97fb;
    }
    
    .btn-primary.modern-btn:hover {
        background-color: #3a84e8;
        border-color: #3a84e8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 151, 251, 0.25);
    }
    
    /* Status indicators */
    .status-badge {
        padding: 6px 12px;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-badge.draft {
        background-color: #f1f5f9;
        color: #64748b;
    }
    
    .status-badge.active {
        background-color: #dcfce7;
        color: #15803d;
    }
    
    /* Responsive design */
    @media (max-width: 992px) {
        .main-content {
            margin-left: 70px;
        }
    }
    
    @media (max-width: 576px) {
        .main-content {
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-container">
            <div class="page-header">
                <h1 class="page-title">Edit Event</h1>
                <p class="page-subtitle">Update event information</p>
            </div>

            <form method="POST" class="modern-form" id="event-form">
                <!-- Hidden field for event ID -->
                <input type="hidden" id="EventID" name="EventID" value="{{ event.EventID }}">
                
                <!-- Hidden field for shifts data -->
                <input type="hidden" id="shifts_data" name="shifts_data" value="">
                
                <!-- 1. Basic Information Section -->
                <div class="modern-card" id="section-basic-info">
                    <div class="modern-section-header">
                        <h3 class="modern-title">
                            <i class="fas fa-info-circle me-2"></i>Basic Information
                        </h3> 
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="EventName" class="modern-label">Event Name</label>
                                    <input type="text" class="form-control modern-input" id="EventName" name="EventName" value="{{ event.EventName }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="Customerid" class="modern-label">Customer</label>
                                    <select class="form-select modern-select" id="Customerid" name="Customerid" required>
                                        <option value="">Select Customer</option>
                                        {% for customer in customers %}
                                        <option value="{{ customer.customerid }}" 
                                                {% if customer.customerid == event.Customerid %}selected{% endif %}>
                                            {{ customer.customername }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Date and Time Section -->
                <div class="modern-card" id="section-date-time">
                    <div class="modern-section-header">
                        <h3 class="modern-title">
                            <i class="fas fa-clock me-2"></i>Date and Time
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="form-group modern-form-group">
                                    <label for="EventStart" class="modern-label">Start Date/Time</label>
                                    <input type="datetime-local" class="form-control modern-input" id="EventStart" name="EventStart" value="{{ event.EventStart.strftime('%Y-%m-%dT%H:%M') if event.EventStart }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group modern-form-group">
                                    <label for="EventEnd" class="modern-label">End Date/Time</label>
                                    <input type="datetime-local" class="form-control modern-input" id="EventEnd" name="EventEnd" value="{{ event.EventEnd.strftime('%Y-%m-%dT%H:%M') if event.EventEnd }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group modern-form-group">
                                    <label for="EventDurationHours" class="modern-label">Event Duration (Hours)</label>
                                    <input type="number" class="form-control modern-input" id="EventDurationHours" name="EventDurationHours" value="{{ event.EventDurationHours or 0 }}" step="0.01" min="0" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Location Section -->
                <div class="modern-card" id="section-location">
                    <div class="modern-section-header">
                        <h3 class="modern-title">
                            <i class="fas fa-map-marker-alt me-2"></i>Location
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-12">
                                <div class="form-group modern-form-group">
                                    <label for="EventLocation" class="modern-label">Location</label>
                                    <input type="text" class="form-control modern-input" id="EventLocation" name="EventLocation" value="{{ event.EventLocation }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. Staff Requirements Section -->
                <div class="modern-card" id="section-staff">
                    <div class="modern-section-header">
                        <h3 class="modern-title">
                            <i class="fas fa-users me-2"></i>Staff Requirements
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="WaitersNeeded" class="modern-label">Waiters Needed</label>
                                    <input type="number" class="form-control modern-input calc-total" id="WaitersNeeded" name="WaitersNeeded" value="{{ event.WaitersNeeded or 0 }}" min="0" oninput="updateTotal()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="BartendersNeeded" class="modern-label">Bartenders Needed</label>
                                    <input type="number" class="form-control modern-input calc-total" id="BartendersNeeded" name="BartendersNeeded" value="{{ event.BartendersNeeded or 0 }}" min="0" oninput="updateTotal()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="MaleEmployees" class="modern-label">Male Employees</label>
                                    <input type="number" class="form-control modern-input calc-total" id="MaleEmployees" name="MaleEmployees" value="{{ event.MaleEmployees or 0 }}" min="0" oninput="updateTotal()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="FemaleEmployees" class="modern-label">Female Employees</label>
                                    <input type="number" class="form-control modern-input calc-total" id="FemaleEmployees" name="FemaleEmployees" value="{{ event.FemaleEmployees or 0 }}" min="0" oninput="updateTotal()">
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-group modern-form-group">
                                    <label for="TotalEmployees" class="modern-label">Total Employees</label>
                                    <input type="number" id="TotalEmployees" name="TotalEmployees" class="form-control modern-input" value="{{ event.TotalEmployees or 0 }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. Shift Management Section -->
                <div class="modern-card" id="section-shifts">
                    <div class="modern-section-header">
                        <h3 class="modern-title">
                            <i class="fas fa-calendar-alt me-2"></i>Shift Management
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-primary modern-btn" id="addShiftBtn">
                                    <i class="fas fa-plus-circle me-2"></i>Add Shift
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Shift Name</th>
                                        <th>Type</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Employees</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shiftsTableBody">
                                    {% for shift in shifts %}
                                    <tr>
                                        <td>{{ shift.shiftname }}</td>
                                        <td>{{ shift.shifttype }}</td>
                                        <td>{{ shift.shiftstart.strftime('%Y-%m-%d %H:%M') if shift.shiftstart }}</td>
                                        <td>{{ shift.shiftend.strftime('%Y-%m-%d %H:%M') if shift.shiftend }}</td>
                                        <td>{{ shift.employee_count }}</td>
                                        <td>
                                            <div class="d-flex gap-1">
                                                <button type="button" class="btn btn-sm btn-outline-primary assign-employees" 
                                                        data-bs-shift-id="{{ shift.shiftid }}" data-bs-shift-name="{{ shift.shiftname }}">
                                                    <i class="fas fa-user-plus"></i> Assign
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary edit-shift" 
                                                        data-bs-shift-id="{{ shift.shiftid }}">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-shift" 
                                                        data-bs-shift-id="{{ shift.shiftid }}" data-bs-shift-name="{{ shift.shiftname }}">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 6. Financial Information Section -->
                <div class="modern-card" id="section-financial">
                    <div class="modern-section-header">
                        <h3 class="modern-title">
                            <i class="fas fa-euro-sign me-2"></i>Financial Information
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="EventPerHourcost" class="modern-label">Cost Per Hour</label>
                                    <div class="input-group modern-input-group">
                                        <span class="input-group-text modern-input-text">€</span>
                                        <input type="number" class="form-control modern-input" id="EventPerHourcost" name="EventPerHourcost" value="{{ event.EventPerHourcost or 0.00 }}" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="EventPerHourselling" class="modern-label">Selling Price Per Hour</label>
                                    <div class="input-group modern-input-group">
                                        <span class="input-group-text modern-input-text">€</span>
                                        <input type="number" class="form-control modern-input" id="EventPerHourselling" name="EventPerHourselling" value="{{ event.EventPerHourselling or 0.00 }}" step="0.01" min="0">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="totalhours" class="modern-label">Total Hours</label>
                                    <input type="number" class="form-control modern-input" id="totalhours" name="totalhours" value="{{ event.totalhours or 0.00 }}" step="0.01" min="0" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group modern-form-group">
                                    <label for="totalshifthours" class="modern-label">Total Shift Hours</label>
                                    <input type="number" class="form-control modern-input" id="totalshifthours" name="totalshifthours" value="{{ event.totalshifthours or 0.00 }}" step="0.01" min="0" readonly>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group modern-form-group">
                                    <label for="totalcost" class="modern-label">Total Cost</label>
                                    <div class="input-group modern-input-group">
                                        <span class="input-group-text modern-input-text">€</span>
                                        <input type="number" class="form-control modern-input" id="totalcost" name="totalcost" value="{{ event.totalcost or 0.00 }}" step="0.01" min="0" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group modern-form-group">
                                    <label for="totalselling" class="modern-label">Total Selling Price</label>
                                    <div class="input-group modern-input-group">
                                        <span class="input-group-text modern-input-text">€</span>
                                        <input type="number" class="form-control modern-input" id="totalselling" name="totalselling" value="{{ event.totalselling or 0.00 }}" step="0.01" min="0" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group modern-form-group">
                                    <label for="totalprofit" class="modern-label">Total Profit</label>
                                    <div class="input-group modern-input-group">
                                        <span class="input-group-text modern-input-text">€</span>
                                        <input type="number" class="form-control modern-input" id="totalprofit" name="totalprofit" value="{{ event.totalprofit or 0.00 }}" step="0.01" min="0" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 7. Notes & Status Section -->
                <div class="modern-card" id="section-status">
                    <div class="modern-section-header">
                        <h3 class="modern-title">
                            <i class="fas fa-tasks me-2"></i>Notes & Status
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-12 px-0">
                                <div class="form-group modern-form-group" style="width: 100%;">
                                    <label for="notes" class="modern-label">Additional Notes</label>
                                    <textarea class="form-control modern-input" id="notes" name="notes" rows="4" style="width: 100%; min-width: 100%; max-width: 100%; box-sizing: border-box; display: block;">{{ event.notes }}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 col-md-6 px-0">
                                <div class="form-group modern-form-group">
                                    <label for="EventStage" class="modern-label">Event Status</label>
                                    <select class="form-select modern-select" id="EventStage" name="EventStage">
                                        <option value="Creation" {% if event.EventStage == 'Creation' %}selected{% endif %}>Creation</option>
                                        <option value="Invoiced" {% if event.EventStage == 'Invoiced' %}selected{% endif %}>Invoiced</option>
                                        <option value="Bank Export" {% if event.EventStage == 'Bank Export' %}selected{% endif %}>Bank Export</option>
                                        <option value="Completed" {% if event.EventStage == 'Completed' %}selected{% endif %}>Completed</option>
                                    </select>
                                    <small class="form-text text-muted">Current status of the event</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Report Section -->
                <div class="modern-card shadow-sm mb-4" id="section-staff-report">
                    <div class="card-header modern-card-header d-flex align-items-center">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        <h5 class="mb-0">Staff Distribution Report</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    This report shows the distribution of staff by gender and role.
                                    It updates automatically as you adjust staff requirements.
                                </div>
                                
                                <div class="table-responsive mt-3">
                                    <table class="table table-bordered table-hover" id="staffCrosstabTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Role / Gender</th>
                                                <th>Male</th>
                                                <th>Female</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <th>Waiters</th>
                                                <td id="male-waiters">0</td>
                                                <td id="female-waiters">0</td>
                                                <td id="total-waiters">0</td>
                                            </tr>
                                            <tr>
                                                <th>Bartenders</th>
                                                <td id="male-bartenders">0</td>
                                                <td id="female-bartenders">0</td>
                                                <td id="total-bartenders">0</td>
                                            </tr>
                                            <tr class="table-secondary">
                                                <th>Total</th>
                                                <td id="total-male">0</td>
                                                <td id="total-female">0</td>
                                                <td id="grand-total">0</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-4">
                                    <h6 class="fw-bold">Distribution Analysis</h6>
                                    <div id="staffDistributionChart" style="height: 200px;">
                                        <div class="d-flex justify-content-between">
                                            <div class="progress-info mb-2">
                                                <label>Males:</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div id="male-progress" class="progress-bar bg-primary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                                </div>
                                            </div>
                                            <div class="progress-info mb-2">
                                                <label>Females:</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div id="female-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-3">
                                            <div class="progress-info mb-2">
                                                <label>Waiters:</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div id="waiters-progress" class="progress-bar bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                                </div>
                                            </div>
                                            <div class="progress-info mb-2">
                                                <label>Bartenders:</label>
                                                <div class="progress" style="height: 20px;">
                                                    <div id="bartenders-progress" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Submit Button -->
                <div class="row mt-4">
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-primary modern-btn">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                        <a href="{{ url_for('event_list') }}" class="btn btn-secondary modern-btn">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Keep the existing modals but with updated styling -->
<!-- Add Shift Modal -->
<div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="addShiftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addShiftModalLabel">Add New Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addShiftForm">
                    <div class="form-group modern-form-group">
                        <label for="shiftName" class="modern-label">Shift Name</label>
                        <input type="text" class="form-control modern-input" id="shiftName" name="shiftName" required>
                    </div>
                    <div class="form-group modern-form-group">
                        <label for="shiftType" class="modern-label">Shift Type</label>
                        <select class="form-control modern-select" id="shiftType" name="shiftType" required>
                            <option value="Full">Full</option>
                            <option value="Partial">Partial</option>
                        </select>
                    </div>
                    <div class="form-group modern-form-group">
                        <label for="shiftStart" class="modern-label">Start Time</label>
                        <input type="datetime-local" class="form-control modern-input" id="shiftStart" name="shiftStart" required>
                    </div>
                    <div class="form-group modern-form-group">
                        <label for="shiftEnd" class="modern-label">End Time</label>
                        <input type="datetime-local" class="form-control modern-input" id="shiftEnd" name="shiftEnd" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modern-btn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary modern-btn" id="saveShiftBtn">Save Shift</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Shift Modal -->
<div class="modal fade" id="editShiftModal" tabindex="-1" aria-labelledby="editShiftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editShiftModalLabel">Edit Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editShiftForm">
                    <input type="hidden" id="editShiftId" name="shiftId">
                    <div class="form-group modern-form-group">
                        <label for="editShiftName" class="modern-label">Shift Name</label>
                        <input type="text" class="form-control modern-input" id="editShiftName" name="shiftName" required>
                    </div>
                    <div class="form-group modern-form-group">
                        <label for="editShiftType" class="modern-label">Shift Type</label>
                        <select class="form-control modern-select" id="editShiftType" name="shiftType" required>
                            <option value="Full">Full</option>
                            <option value="Partial">Partial</option>
                        </select>
                    </div>
                    <div class="form-group modern-form-group">
                        <label for="editShiftStart" class="modern-label">Start Time</label>
                        <input type="datetime-local" class="form-control modern-input" id="editShiftStart" name="shiftStart" required>
                    </div>
                    <div class="form-group modern-form-group">
                        <label for="editShiftEnd" class="modern-label">End Time</label>
                        <input type="datetime-local" class="form-control modern-input" id="editShiftEnd" name="shiftEnd" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modern-btn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary modern-btn" id="updateShiftBtn">Update Shift</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Employees Modal -->
<div class="modal fade" id="assignEmployeesModal" tabindex="-1" aria-labelledby="assignEmployeesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignEmployeesModalLabel">Assign Employees to Shift</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" id="shiftInfoAlert"></div>
                <form id="assignEmployeesForm">
                    <input type="hidden" id="assignShiftId" name="shiftId">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>Select</th>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Gender</th>
                                    <th>Hours (Partial Only)</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                                <!-- Employee rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modern-btn" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary modern-btn" id="saveAssignmentsBtn">Save Assignments</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add submit event listener to the form to ensure shifts data is included
        const eventForm = document.getElementById('event-form');
        if (eventForm) {
            eventForm.addEventListener('submit', function(e) {
                // Prevent default submission
                e.preventDefault();
                
                try {
                    // Get all shifts from the shifts table
                    const shiftRows = document.querySelectorAll('#shiftsTableBody tr');
                    const shiftsArray = [];
                    
                    // Create an array of promises to fetch employee assignments
                    const promises = Array.from(shiftRows).map(row => {
                        return new Promise((resolve) => {
                            try {
                                const editButton = row.querySelector('button.edit-shift');
                                if (!editButton) {
                                    console.warn("No edit button found in row");
                                    resolve(null);
                                    return;
                                }
                                
                                const shiftId = editButton.getAttribute('data-bs-shift-id');
                                const shiftName = row.cells[0].textContent;
                                const shiftType = row.cells[1].textContent;
                                const shiftStart = row.cells[2].textContent;
                                const shiftEnd = row.cells[3].textContent;
                                const employeeCount = parseInt(row.cells[4].textContent) || 0;
                                
                                // Create a shift object
                                const shift = {
                                    shiftid: shiftId,
                                    name: shiftName,
                                    type: shiftType,
                                    start: shiftStart,
                                    end: shiftEnd,
                                    employee_count: employeeCount,
                                    employees: []
                                };
                                
                                // Fetch employee assignments for this shift
                                fetch(`/api/shifts/${shiftId}/employees`)
                                    .then(response => response.json())
                                    .then(data => {
                                        // Add assigned employees to the shift
                                        if (data && data.employees) {
                                            data.employees.forEach(emp => {
                                                if (emp.assigned) {
                                                    shift.employees.push({
                                                        id: emp.employeeid,
                                                        employeeid: emp.employeeid,
                                                        name: emp.name,
                                                        role: emp.role,
                                                        hours: emp.hours || 0
                                                    });
                                                }
                                            });
                                        }
                                        resolve(shift);
                                    })
                                    .catch(error => {
                                        console.error(`Error fetching employees for shift ${shiftId}:`, error);
                                        resolve(shift); // Still resolve with the shift even if employee fetch fails
                                    });
                            } catch (err) {
                                console.error("Error processing shift row:", err);
                                resolve(null);
                            }
                        });
                    });
                    
                    // Wait for all employee data to be fetched
                    Promise.all(promises).then(shifts => {
                        // Filter out null shifts
                        const validShifts = shifts.filter(s => s !== null);
                        
                        // Save the shifts data to the hidden input
                        document.getElementById('shifts_data').value = JSON.stringify(validShifts);
                        console.log("Saving shifts data with employees:", validShifts);
                        
                        // Submit the form
                        eventForm.submit();
                    });
                } catch (e) {
                    console.error("Error collecting shifts data:", e);
                    // Submit the form anyway if there was an error
                    eventForm.submit();
                }
            });
        }
        
        // Initialize all Bootstrap 5 modals
        try {
            const modalElements = document.querySelectorAll('.modal');
            window.appModals = {};
            
            modalElements.forEach(modalElement => {
                try {
                    // Create modal objects for each modal element
                    const modal = new bootstrap.Modal(modalElement);
                    
                    // Store modal in a global map for later access
                    window.appModals[modalElement.id] = modal;
                    console.log('Modal initialized:', modalElement.id);
                } catch (e) {
                    console.error('Error initializing modal:', modalElement.id, e);
                }
            });
        } catch (e) {
            console.error('Error in modal initialization:', e);
        }
        
        // Debug: Log shifts data from server
        console.log("Shifts from server:", JSON.parse('{{ shifts|tojson }}'));
        console.log("ShiftsTable DOM element exists:", !!document.getElementById('shiftsTableBody'));
        console.log("Number of shift rows:", document.querySelectorAll('#shiftsTableBody tr').length);
        
        // Initialize sidebar navigation
        initSidebar();
        
        // Set the first item as active by default
        setActiveNavItem(document.querySelector('.nav-item[data-section]'));
    });
    
    function initSidebar() {
        // Get all nav items with data-section attribute
        const navItems = document.querySelectorAll('.nav-item[data-section]');
        
        // Add click event listeners to each nav item
        navItems.forEach(function(item) {
            item.addEventListener('click', function() {
                const sectionId = this.getAttribute('data-section');
                scrollToSection(sectionId);
                setActiveNavItem(this);
            });
        });
        
        // Add event listeners for action items
        const actionItems = document.querySelectorAll('.nav-item[data-action]');
        actionItems.forEach(function(item) {
            item.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                performAction(action);
            });
        });
    }
    
    function scrollToSection(sectionId) {
        const section = document.getElementById(sectionId);
        if (section) {
            // Scroll the section into view with smooth behavior
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    function setActiveNavItem(activeItem) {
        // Remove active class from all items
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(function(item) {
            item.classList.remove('active');
        });
        
        // Add active class to the clicked item
        if (activeItem) {
            activeItem.classList.add('active');
        }
    }
    
    function performAction(action) {
        if (action === 'save-form') {
            // Let the form's submit event handler handle this
            const form = document.getElementById('event-form');
            if (form) {
                // The submit event handler will take care of collecting shifts data
                form.dispatchEvent(new Event('submit'));
            } else {
                console.error("Could not find event form!");
            }
        } else if (action === 'cancel-form') {
            // Redirect to events list page
            window.location.href = "{{ url_for('event_list') }}";
        }
    }
    
    // Add scroll event listener to update active sidebar item based on scroll position
    window.addEventListener('scroll', function() {
        const sections = document.querySelectorAll('.modern-card[id^="section-"]');
        let currentSection = '';
        
        sections.forEach(function(section) {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.offsetHeight;
            
            if (window.pageYOffset >= (sectionTop - 100)) {
                currentSection = section.getAttribute('id');
            }
        });
        
        if (currentSection) {
            const activeNavItem = document.querySelector(`.nav-item[data-section="${currentSection}"]`);
            if (activeNavItem) {
                setActiveNavItem(activeNavItem);
            }
        }
    });
    
    // Update total employees count
    function updateTotal() {
        console.log("Updating total employees calculation");
        
        // Get elements with error checking
        const waitersElem = document.getElementById('WaitersNeeded');
        const bartendersElem = document.getElementById('BartendersNeeded');
        const malesElem = document.getElementById('MaleEmployees');
        const femalesElem = document.getElementById('FemaleEmployees');
        const totalElem = document.getElementById('TotalEmployees');
        const errorElement = document.getElementById('totalEmployeesError');
        
        // Check if elements exist
        if (!waitersElem || !bartendersElem || !totalElem) {
            console.error("Required employee count elements not found:", 
                !waitersElem ? "WaitersNeeded missing" : "",
                !bartendersElem ? "BartendersNeeded missing" : "",
                !totalElem ? "TotalEmployees missing" : "");
            return;
        }
        
        // Parse values with fallback to 0
        const waiters = parseInt(waitersElem.value) || 0;
        const bartenders = parseInt(bartendersElem.value) || 0;
        const males = malesElem ? (parseInt(malesElem.value) || 0) : 0;
        const females = femalesElem ? (parseInt(femalesElem.value) || 0) : 0;
        
        // Calculate total
        const positionTotal = waiters + bartenders;
        console.log("Position totals:", {waiters, bartenders, positionTotal});
        
        // Update the total field
        totalElem.value = positionTotal;
        
        // Show warning if gender total doesn't match position total
        if (errorElement && malesElem && femalesElem) {
            if (males + females !== positionTotal) {
                errorElement.textContent = "Warning: Gender distribution does not match total employees needed.";
                errorElement.style.display = "block";
            } else {
                errorElement.style.display = "none";
            }
        }
        
        // Update staff distribution report
        updateStaffDistributionReport(waiters, bartenders, males, females);
    }
    
    // Update the staff distribution report
    function updateStaffDistributionReport(waiters, bartenders, males, females) {
        // Calculate the distribution values
        const totalStaff = males + females;
        const malePercent = totalStaff > 0 ? Math.round((males / totalStaff) * 100) : 0;
        const femalePercent = totalStaff > 0 ? Math.round((females / totalStaff) * 100) : 0;
        
        const waiterPercent = totalStaff > 0 ? Math.round((waiters / totalStaff) * 100) : 0;
        const bartenderPercent = totalStaff > 0 ? Math.round((bartenders / totalStaff) * 100) : 0;
        
        // Only calculate detailed distribution if gender and position totals match
        if (males + females === waiters + bartenders) {
            // Create a distribution matrix - this is a simplified approach
            // In a real system, we'd need more complex logic to determine exact distribution
            
            // Calculate approximate distribution
            // Logic: Distribute males/females proportionally across roles
            let maleWaiters = Math.round((males * waiters) / totalStaff) || 0;
            let femaleBartenders = Math.round((females * bartenders) / totalStaff) || 0;
            
            // Adjust to ensure totals add up correctly
            let maleBartenders = males - maleWaiters;
            let femaleWaiters = waiters - maleWaiters;
            
            // Handle edge cases
            if (maleBartenders < 0) {
                maleWaiters = males;
                maleBartenders = 0;
            }
            
            if (femaleWaiters < 0) {
                femaleWaiters = 0;
                maleWaiters = waiters;
            }
            
            if (femaleBartenders < 0) {
                femaleBartenders = 0;
                maleBartenders = bartenders;
            }
            
            // Update the table cells
            document.getElementById('male-waiters').textContent = maleWaiters;
            document.getElementById('female-waiters').textContent = femaleWaiters;
            document.getElementById('total-waiters').textContent = waiters;
            
            document.getElementById('male-bartenders').textContent = maleBartenders;
            document.getElementById('female-bartenders').textContent = femaleBartenders;
            document.getElementById('total-bartenders').textContent = bartenders;
            
            document.getElementById('total-male').textContent = males;
            document.getElementById('total-female').textContent = females;
            document.getElementById('grand-total').textContent = totalStaff;
        } else {
            // If totals don't match, show question marks in distribution cells
            document.getElementById('male-waiters').textContent = '?';
            document.getElementById('female-waiters').textContent = '?';
            document.getElementById('male-bartenders').textContent = '?';
            document.getElementById('female-bartenders').textContent = '?';
            
            // Still show the row and column totals
            document.getElementById('total-waiters').textContent = waiters;
            document.getElementById('total-bartenders').textContent = bartenders;
            document.getElementById('total-male').textContent = males;
            document.getElementById('total-female').textContent = females;
            document.getElementById('grand-total').textContent = totalStaff;
        }
        
        // Update progress bars
        updateProgressBar('male-progress', malePercent);
        updateProgressBar('female-progress', femalePercent);
        updateProgressBar('waiters-progress', waiterPercent);
        updateProgressBar('bartenders-progress', bartenderPercent);
    }
    
    // Helper function to update a progress bar
    function updateProgressBar(id, percentage) {
        const progressBar = document.getElementById(id);
        if (progressBar) {
            progressBar.style.width = percentage + '%';
            progressBar.setAttribute('aria-valuenow', percentage);
            progressBar.textContent = percentage + '%';
        }
    }
    
    // Helper function to populate the employee table in the assign modal
    function populateEmployeeTable(employees, assignedEmployees, shiftType) {
        const tableBody = document.getElementById('employeesTableBody');
        tableBody.innerHTML = '';
        
        if (!employees || employees.length === 0) {
            // No employees available
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" class="text-center">No employees available</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // Create a map of assigned employees for quick lookup
        const assignedMap = {};
        if (assignedEmployees && assignedEmployees.length > 0) {
            assignedEmployees.forEach(function(employee) {
                assignedMap[employee.employeeid] = employee.hours || 0;
            });
        }
        
        // Add a row for each employee
        employees.forEach(function(employee) {
            const isAssigned = assignedMap.hasOwnProperty(employee.employeeid);
            const assignedHours = isAssigned ? assignedMap[employee.employeeid] : 0;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input employee-select" 
                               id="emp-${employee.employeeid}" 
                               name="selected_employees" 
                               value="${employee.employeeid}" 
                               ${isAssigned ? 'checked' : ''}>
                    </div>
                </td>
                <td>${employee.firstname} ${employee.lastname}</td>
                <td>${employee.role || 'N/A'}</td>
                <td>${employee.gender || 'N/A'}</td>
                <td>
                    ${shiftType === 'Partial' ? 
                        `<input type="number" class="form-control form-control-sm assigned-hours" 
                                name="hours_${employee.employeeid}" 
                                value="${assignedHours}" 
                                min="0" step="0.5" ${!isAssigned ? 'disabled' : ''}>` 
                        : 
                        'Full Shift'}
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Add event listener to checkbox
            const checkbox = row.querySelector(`#emp-${employee.employeeid}`);
            const hoursInput = row.querySelector(`input[name="hours_${employee.employeeid}"]`);
            
            if (checkbox && hoursInput) {
                checkbox.addEventListener('change', function() {
                    hoursInput.disabled = !this.checked;
                    if (this.checked) {
                        hoursInput.value = hoursInput.value || 1;
                    }
                });
            }
        });
    }
    
    // Document ready function
    document.addEventListener('DOMContentLoaded', function() {
        // Add events to staff requirement fields
        const waitersField = document.getElementById('WaitersNeeded');
        const bartendersField = document.getElementById('BartendersNeeded');
        const malesField = document.getElementById('MaleEmployees');
        const femalesField = document.getElementById('FemaleEmployees');
        
        if (waitersField) waitersField.addEventListener('input', updateTotal);
        if (bartendersField) bartendersField.addEventListener('input', updateTotal);
        if (malesField) malesField.addEventListener('input', updateTotal);
        if (femalesField) femalesField.addEventListener('input', updateTotal);
        
        // Initialize the staff distribution report with current values
        updateTotal();
        
        // Set up event handlers for shift management buttons
        const addShiftBtn = document.getElementById('addShiftBtn');
        if (addShiftBtn) {
            addShiftBtn.addEventListener('click', function() {
                // Try to use Bootstrap 5 modal API first
                try {
                    // Pre-fill with event start/end times
                    const eventStart = document.getElementById('EventStart').value;
                    const eventEnd = document.getElementById('EventEnd').value;
                    
                    if (eventStart && eventEnd) {
                        document.getElementById('shiftStart').value = eventStart;
                        document.getElementById('shiftEnd').value = eventEnd;
                    }
                    
                    // Get modal element
                    const modalElement = document.getElementById('addShiftModal');
                    
                    // If we have Bootstrap 5, use it
                    if (window.appModals && window.appModals['addShiftModal']) {
                        window.appModals['addShiftModal'].show();
                    } else if (typeof bootstrap !== 'undefined') {
                        const addShiftModal = new bootstrap.Modal(modalElement);
                        addShiftModal.show();
                    } else {
                        // Fallback to jQuery for Bootstrap 4
                        $(modalElement).modal('show');
                    }
                    
                    console.log('Opened add shift modal');
                } catch (e) {
                    console.error('Error showing modal:', e);
                    alert('Error opening modal: ' + e.message);
                }
            });
        }
        
        // Set up edit shift buttons
        const editButtons = document.querySelectorAll('.edit-shift');
        if (editButtons.length > 0) {
            editButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const shiftId = this.getAttribute('data-bs-shift-id');
                    // Fetch shift data and open edit modal
                    fetch(`/api/shifts/${shiftId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Fetched shift data:', data);
                            document.getElementById('editShiftId').value = data.shiftid;
                            document.getElementById('editShiftName').value = data.shiftname;
                            document.getElementById('editShiftType').value = data.shifttype;
                            
                            // Format datetime for input
                            try {
                                const startDate = new Date(data.shiftstart);
                                const endDate = new Date(data.shiftend);
                                
                                // Format as YYYY-MM-DDTHH:MM
                                const formatDateForInput = (date) => {
                                    return date.getFullYear() + '-' + 
                                        String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                                        String(date.getDate()).padStart(2, '0') + 'T' + 
                                        String(date.getHours()).padStart(2, '0') + ':' + 
                                        String(date.getMinutes()).padStart(2, '0');
                                };
                                
                                document.getElementById('editShiftStart').value = formatDateForInput(startDate);
                                document.getElementById('editShiftEnd').value = formatDateForInput(endDate);
                            } catch(e) {
                                console.error('Error formatting dates:', e);
                            }
                            
                            // Show modal with Bootstrap 5
                            if (window.appModals && window.appModals['editShiftModal']) {
                                window.appModals['editShiftModal'].show();
                                console.log('Opened edit shift modal for shift ID:', shiftId);
                            } else {
                                console.error('Edit modal not initialized');
                                // Try to initialize it now
                                try {
                                    const modalElement = document.getElementById('editShiftModal');
                                    if (modalElement) {
                                        const modal = new bootstrap.Modal(modalElement);
                                        window.appModals = window.appModals || {};
                                        window.appModals['editShiftModal'] = modal;
                                        modal.show();
                                        console.log('Dynamically initialized edit modal');
                                    }
                                } catch (e) {
                                    console.error('Could not initialize modal dynamically:', e);
                                }
                            }
                        })
                        .catch(error => console.error('Error fetching shift data:', error));
                });
            });
        }
        
        // Set up delete shift buttons
        const deleteButtons = document.querySelectorAll('.delete-shift');
        if (deleteButtons.length > 0) {
            deleteButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const shiftId = this.getAttribute('data-bs-shift-id');
                    const shiftName = this.getAttribute('data-bs-shift-name');
                    
                    if (confirm(`Are you sure you want to delete the shift "${shiftName}"?`)) {
                        // Send delete request
                        fetch(`/shifts/${shiftId}/delete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                // Reload the page to show updated shifts
                                window.location.reload();
                            } else {
                                alert('Error deleting shift. Please try again.');
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    }
                });
            });
        }
        
        // Set up assign employees buttons
        const assignButtons = document.querySelectorAll('.assign-employees');
        if (assignButtons.length > 0) {
            assignButtons.forEach(function(button) {
                button.addEventListener('click', function() {
                    const shiftId = this.getAttribute('data-bs-shift-id');
                    const shiftName = this.getAttribute('data-bs-shift-name');
                    
                    document.getElementById('assignShiftId').value = shiftId;
                    document.getElementById('shiftInfoAlert').textContent = 
                        `Assigning employees to shift: ${shiftName}`;
                    
                    // Fetch employees for this shift
                    fetch(`/api/shifts/${shiftId}/employees`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Employees data received:', data);
                            populateEmployeeTable(data.employees, data.assigned_employees, data.shift_type);
                            
                            // Show modal with Bootstrap 5
                            if (window.appModals && window.appModals['assignEmployeesModal']) {
                                window.appModals['assignEmployeesModal'].show();
                                console.log('Opened assign employees modal for shift:', shiftName);
                            } else {
                                console.error('Assign modal not initialized');
                                // Try to initialize it now
                                try {
                                    const modalElement = document.getElementById('assignEmployeesModal');
                                    if (modalElement) {
                                        const modal = new bootstrap.Modal(modalElement);
                                        window.appModals = window.appModals || {};
                                        window.appModals['assignEmployeesModal'] = modal;
                                        modal.show();
                                        console.log('Dynamically initialized assign modal');
                                    }
                                } catch (e) {
                                    console.error('Could not initialize modal dynamically:', e);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching employees:', error);
                            alert('Error loading employees. Please try again.');
                        });
                });
            });
        }
        
        // Handle save new shift
        const saveShiftBtn = document.getElementById('saveShiftBtn');
        if (saveShiftBtn) {
            saveShiftBtn.addEventListener('click', function() {
                const form = document.getElementById('addShiftForm');
                const formData = new FormData(form);
                const eventId = document.getElementById('EventID').value;
                
                // Convert to JSON object
                const shiftData = {
                    eventid: eventId,
                    shiftname: formData.get('shiftName'),
                    shifttype: formData.get('shiftType'),
                    shiftstart: formData.get('shiftStart'),
                    shiftend: formData.get('shiftEnd')
                };
                
                console.log('Saving shift data:', shiftData);
                
                // Send API request to create shift
                fetch(`/events/${eventId}/shifts/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shiftData)
                })
                .then(response => {
                    if (response.ok) {
                        // Hide modal and reload page
                        if (window.appModals && window.appModals['addShiftModal']) {
                            window.appModals['addShiftModal'].hide();
                        }
                        window.location.reload();
                    } else {
                        alert('Error creating shift. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error creating shift: ' + error.message);
                });
            });
        }
        
        // Handle update shift
        const updateShiftBtn = document.getElementById('updateShiftBtn');
        if (updateShiftBtn) {
            updateShiftBtn.addEventListener('click', function() {
                const form = document.getElementById('editShiftForm');
                const formData = new FormData(form);
                const shiftId = formData.get('shiftId');
                
                // Convert to JSON object
                const shiftData = {
                    shiftname: formData.get('shiftName'),
                    shifttype: formData.get('shiftType'),
                    shiftstart: formData.get('shiftStart'),
                    shiftend: formData.get('shiftEnd')
                };
                
                // Send API request to update shift
                fetch(`/shifts/${shiftId}/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shiftData)
                })
                .then(response => {
                    if (response.ok) {
                        // Close modal and reload page
                        if (window.appModals && window.appModals['editShiftModal']) {
                            window.appModals['editShiftModal'].hide();
                        }
                        window.location.reload();
                    } else {
                        alert('Error updating shift. Please try again.');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }
        
        // Log shift data to console for debugging
        console.log("Number of shifts found:", document.querySelectorAll('#shiftsTableBody tr').length);
        
        // Make shifts data available to JavaScript
        const initialShifts = [];
        
        // Add event handlers for employee assignment
        const saveAssignmentsBtn = document.getElementById('saveAssignmentsBtn');
        if (saveAssignmentsBtn) {
            saveAssignmentsBtn.addEventListener('click', function() {
                const shiftId = document.getElementById('assignShiftId').value;
                const selectedEmployees = [];
                
                // Gather selected employees and their hours
                document.querySelectorAll('.employee-select:checked').forEach(function(checkbox) {
                    const employeeId = checkbox.value;
                    const hoursInput = document.querySelector(`input[name="hours_${employeeId}"]`);
                    const hours = hoursInput ? parseFloat(hoursInput.value) || 0 : 0;
                    
                    selectedEmployees.push({
                        employeeid: employeeId,
                        hours: hours
                    });
                });
                
                // Send API request to save assignments
                fetch(`/shifts/${shiftId}/assign/${eventId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        employees: selectedEmployees
                    })
                })
                .then(response => {
                    if (response.ok) {
                        // Close modal and reload page
                        $('#assignEmployeesModal').modal('hide');
                        window.location.reload();
                    } else {
                        alert('Error saving assignments. Please try again.');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }
    });
</script>
{% endblock %} 